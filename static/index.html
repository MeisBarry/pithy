<LINK REL=StyleSheet HREF="static/style.css" TYPE="text/css" MEDIA=screen>
	
<script src="static/jquery.js" type="text/javascript" charset="utf-8"></script> 
<script src="static/jquery.imagesloaded.js" type="text/javascript" charset="utf-8"></script> 
<script src="static/ace/build/src/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="static/ace/build/src/mode-python.js" type="text/javascript" charset="utf-8"></script>
<script src="static/shortcut.js" type="text/javascript" charset="utf-8"></script>
<script src="/channel/bcsocket.js"></script>
<script src="/socket.io/socket.io.js"></script>

<script src="/share/share.js"></script>
<script src="/share/ace.js"></script>


<style>
textarea
{
    margin: auto auto;
	width:100%;
	font-size: 14px;
}



#script_area {
     position: relative;
     width: 500px;
     height: 400px;
	font-family: "Courier New",monospace;
	font-size: 15px;
	
 }


.selectig
{
	outline: none;
}

.code
{
	width:100%;
}

.output
{
    margin: auto auto;
	width:100%;
	height:50%;
	font-size: 15px;
}

body
{
	width: 100%;
}

.texterboxer
{
	border: 1px solid silver;
	background: silver;
	width:200px
}

.left
{
	float:left;
	width:48%;
}
.right
{
	float:right;
	width:50%;
	height:85%;
	
}

.images
{
		width:100%;
		overflow: auto;
		overflow-y: auto;
		overflow-x:hidden;		
		height:100%;


}

.credit
{
	color: silver;
	size: 10px;
	text-align: right;
	position:absolute; 
	bottom:10;
	right:100;
}

.menu_bar
{
	text-align:right;
}

.csvcontainer
{
	height: 10%;
}
</style>

<div class="menu_bar"><span id="history_box"></span> <span id="droplink"></span></div>
<div id="left-side" class="left">
<h3>Code Here</h3>
<div id="script_area"></div>
<div id="code_enter" style="text-align: right;">
<input id="scriptname" class="texterboxer"><button id="save">save</button><button id="run">run</button> (or hit F1)
</div>	
<div id="status" style="height:10px;"></div>

</div>	
<div class="right">
<h3>Output/Errors/Plots Here</h3><div id="images" class="images"></div>
</div>

<div class="credit" id="credit">by <a href="http://steingart.ccny.cuny.edu/dan">Dan Steingart</a>, 2011  </div>

<script>
var changed = false;
var status = $("#status");
var pathname = window.location.pathname;
if (pathname == "/") 
{
	window.location.href = window.location.href + makeid()
}
var page = pathname;
var scrollpos = 0;
height_factor = .7
area = $("#script_area")
var editor = ace.edit("script_area");
area.width($("#left-side").width())
area.height($(document).height()*height_factor)
editor.setPrintMarginColumn(0)
var PythonMode = require("ace/mode/python").Mode;

editor.getSession().setMode(new PythonMode());
editor.setFadeFoldWidgets(false)
editor.setShowPrintMargin(false)
foo = editor.getSession()



foo.setUseWrapMode(true)

//hacks for now
$("#save").hide()
$("#scriptname").hide()
//F1 to run script
shortcut.add("F1",function() {$("#run").click()})

//F2 to cycle themes
themes = ['textmate','twilight','clouds','dawn','midnight','cobalt']
themecycle = 0

shortcut.add("F2",function() 
{
	themecycle ++;
	if (themecycle > (themes.length -1)) themecycle=0;
	editor.setTheme("ace/theme/"+themes[themecycle]);
})

var socket = io.connect('/');

socket.on(page.replace("/",""), function (data) {
				//console.log(data)
				//Let know that we've saved stuff
				changed = false;
				if (data['exec_time'] != undefined)
				{
				$("#status").html("saved, exec time = "+data['exec_time']+"ms");
				//$("#status").fadeOut(1000,function(){$("#status").html("   ")});  
				//$("#status").fadeIn(1000);
			//	console.log("fader rader")
				}
				gotdata = data
				build_output(gotdata)
				history(page);
				//console.log("should be stuffs here")
				
				dfd = $('#images').imagesLoaded(); 
				dfd.always(
					function(){
						$("#images").scrollTop(scrollpos)
						}
				)
				//socket.disconnect()
				//socket = io.connect('/');

});


//cribbed from http://stackoverflow.com/a/1349426/565514
function makeid()
{
    var text = "";
    var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

    for( var i=0; i < 5; i++ )
        text += possible.charAt(Math.floor(Math.random() * possible.length));

    return text;
}


var foo = null
sharejs.open(page.replace("/",""), 'text', function(error, doc) {
 doc.attach_ace(editor);
 if (editor.getSession().getValue() == "") loader(false,page);

});



document.title =  page.split("/")[1] +" - Python in Your Browser"
//$("#droplink").html("<a href='/drops/"+page.split("/")[1]+"' target='_new'>Drop Page</a>")
this_port = "/"+pathname.split("/")[1]+"/"

var gotdata = ""
var maxwidth = 800
function build_output(data)
{
	//console.log("start build")
	
	imgout = "<center>"
	widther = $("#images").width() - 1
	if (widther > maxwidth) widther = maxwidth
	
	outputdata = ""
	//Build python stdout
	//data = JSON.parse(data)
	boots = data['out']
	//while (boots.search("\n") > -1) boots = boots.replace("\n","<br>")
	
	foots = boots.split("\n")
	for (i in foots)
	{
		if (foots[i].search("##_holder_##")==0) outputdata += "<img width='"+widther+"px'src='"+foots[i].replace("##_holder_##:","")+"'><br>"
		else outputdata += foots[i]+"<br>"
	}

	//Build python stderr
	boots = data['outerr']
	if (boots == null) boots = ""
	while (boots.search("\n") > -1) boots = boots.replace("\n","<br>")
	//$("#images").html($("#images").html()+"<br><span style='color:red'>"+boots+"</span>")  
	outputdata += "<br><span style='color:red'>"+boots+"</span>"

	$("#images").html(outputdata)
	//console.log("end build")
	
}

function saver(bool,page)
{

	//editor.save()
	script_name = $("#scriptname").val()
	//console.log(script_name)
	//if ($.trim($("#script_area").text()) != "Fill Me Up")
	if ($.trim(editor.getSession().getValue()) != "Fill Me Up")
	{
		//console.log("Changed!");
		$.ajax(
		{
		  url: this_port+"run/",
		  type:"POST",
		  async:bool,
		  data:{page_name:page,script_name:script_name,value:editor.getSession().getValue(),csvlist:$("#csvselected").val()},
		 
		})
	}
}


function loader(bool,page)
{
	//console.log("loading!");

	$.ajax({
	  url: "read/",
	  async:bool,
	  type:"POST",
	  data:{page_name:page,value:editor.getSession().getValue()},
	  success: function(data){
	//	console.log(data)
		//data = JSON.parse(data)
		
		//$("#script_area").text(data['script']);
	 		editor.getSession().setValue(data['script'])
		//if (data['dataset'].length > 0) $("#csvselected").val(data['dataset']);
		
	  }
	});
	
}

function history(page)
{
	//console.log("loading!");

	$.ajax({
	  url: "history/",
	  async:true,
	  type:"POST",
	  data:{page_name:page,value:editor.getSession().getValue()},
	  success: function(data){
		//data = JSON.parse(data);
		out = data['out']
		if (out == undefined) out = []
		//console.log(out)
		if (out.length > 1)
		{
			selecters = "<select id='histories' class='selectig'>"
			for (i in out)
			{
				selecters += '<option value="'+out[i][0]+'">'+out[i][1]+'</option>'
			}
			selecters += "</select>"
			$("#history_box").html(selecters)
			$("#histories").change(
				function(){get_data()})
		}
	}
	});
	
}


function get_data()
{
	
	loader(false,this_port+$("#histories").val());
	console.log(this_port+$("#histories").val())
	//editor.setValue($("#script_area").text());
}

function make_option(word)
{
  foo = "<option value='Milk'>Milk</option>";
  return foo.replace(/Milk/gi,word)
}


loader(false,page);
history(page);
//getscsvs(page)

//What happens when you click run
$("#run").click(function(){
	scrollpos = $("#images").scrollTop()
	//$("#images").html("waiting for result");
	
	saver(true,page);
	
	});
	
//Editor Stuff



$(window).resize(function(){
	try
	{
		build_output(gotdata)
	}
	catch (err)
	{
		//console.log(err)
	}
	area.width($("#left-side").width())
	area.height($(document).height()*height_factor)
	
	})

</script>
