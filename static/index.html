<LINK REL=StyleSheet HREF="static/style.css" TYPE="text/css" MEDIA=screen>
	
<script src="static/shortcut.js" type="text/javascript" charset="utf-8"></script>
<script src="channel/bcsocket.js"></script>
<script src="socket.io/socket.io.js"></script>

<script src="http://rawgithub.com/ajaxorg/ace-builds/master/src/ace.js" type="text/javascript" charset="utf-8"></script>

<script src="http://rawgithub.com/ajaxorg/ace-builds/master/src/mode-python.js" type="text/javascript" charset="utf-8"></script>
<script src="share/share.js"></script>
<script src="share/ace.js"></script>

<script src="static/jquery.js" type="text/javascript" charset="utf-8"></script> 
<script src="static/jquery.imagesloaded.js" type="text/javascript" charset="utf-8"></script> 



<style>
textarea
{
    margin: auto auto;
	width:100%;
	font-size: 14px;
}



#script_area {
     position: relative;
     width: 500px;
     height: 400px;
	font-family: "Courier New",monospace;
	font-size: 15px;
	
 }


.selectig
{
	outline: none;
}

.code
{
	width:100%;
}

.output
{
    margin: auto auto;
	width:100%;
	height:50%;
	font-size: 15px;
}

body
{
	margin: 0px 0px;
	padding: 0px 0px;
	
	width: 100%;
}

.texterboxer
{
	border: 1px solid silver;
	background: white;
	width:150px
	
}

input:focus {outline: none; }

.left
{
	float:left;
	width:50%;
}
.right
{
	float:right;
	width:50%;
	height:85%;
	
}

.images
{
		width:100%;
		overflow: auto;
		overflow-y: auto;
		overflow-x:hidden;		
		height:100%;


}

.credit
{
	color: silver;
	size: 10px;
	text-align: right;
	position:absolute; 
	bottom:10;
	right:100;
}

.menu_bar
{
	text-align:right;
}

</style>

<div id="left-side" class="left">
<div id="script_area"></div>
<div id="code_enter" style="text-align: right;">
</div>	

</div>	
<div class="right">
	<div class="menu_bar">
		<span id="status" style="height:10px;"></span>
		<input id="scriptname" class="texterboxer">
		<button id="copyto">copy to</button><button id="kill">kill</button>
		<button id="run">run</button>
		<span id="history_box"></span> 
	</div>
	<div id="images" class="images"></div>
</div>

<div class="credit" id="credit">by <a href="http://steingart.ccny.cuny.edu/dan">Dan Steingart</a>, 2011  </div>

<script>



var changed = false;
var status = $("#status");
var pathname = window.location.pathname;
var page = pathname;
var scrollpos = 0;
height_factor = 1
area = $("#script_area")
var editor = ace.edit("script_area");
area.width($("#left-side").width())
area.height($(document).height()*height_factor)
editor.setPrintMarginColumn(0)
//var PythonMode = require().Mode;
editor.getSession().setMode("ace/mode/python");
editor.setFadeFoldWidgets(false)
editor.setShowPrintMargin(false)
foo = editor.getSession()
foo.setUseWrapMode(true)

editor.setTheme("ace/theme/"+getCookie('theme'));


$("#credit").html($("#credit").html()+(" (<a target='_new' href='/shower/"+page.split("/")[1]+"'>results</a>)"))

//hacks for now
$("#save").hide()
//$("#scriptname").hide()
//F1 to run script
shortcut.add("F1",function() {$("#run").click()})

//F2 to cycle themes
themes = ['textmate','twilight','clouds','dawn','midnight','cobalt']
themecycle = 0

var socket = io.connect('/');

var foo = null

document.title =  page.split("/")[1] +" - pithy"
this_port = "/"+pathname.split("/")[1]+"/"

var gotdata = ""
var maxwidth = 800
waiting_for_output = false
loader(true,page);
history(page);

///////////Jquery Foo/////////////
//What happens when you click run
$("#run").click(function(){
	scrollpos = $("#images").scrollTop()
	//$("#images").html("waiting for result");
	
	saver(true,page);
	
});
	
$("#kill").click(function(){
		console.log("kill me please")
		$.ajax(
		{
		  url: "/killer/",
		  type:"POST",
		  data:{page_name:page}
		})

});


$("#copyto").click(function(){
		console.log("copy me please")
		script_name = $("#scriptname").val()
		
		$.ajax(
		{			
		  url: "/copyto/",
		  type:"POST",
		  data:{page_name:page,script_name:script_name,value:editor.getSession().getValue()},
		  success: function(data)
			{
		 		gotor = data['redirect']
				console.log(data)
				window.location.href = gotor;
				//window.location.host+"/"+gotor)
			}
		  
		
		})

});

shortcut.add("F2",function(){
	themecycle ++;
	if (themecycle > (themes.length -1)) themecycle=0;
	editor.setTheme("ace/theme/"+themes[themecycle]);
	setCookie('theme',themes[themecycle]);
})

/////////////Socket Foo/////////
doo = null
err = null
sharejs.open(page.replace("/",""), 'text', function(error, doc) {
doc.attach_ace(editor);
 if (editor.getSession().getValue() == "") loader(false,page);
});

socket.on(page.replace("/",""), function (data) {
				//Let know that we've saved stuff
				
				//console.log(data)
				changed = false;
				if (data['exec_time'] != undefined)
				{
					waiting_for_output = false
					$("#status").html("saved, exec time = "+data['exec_time']+"ms");
				}
				gotdata = data
				build_output(gotdata)
				history(page);
				//console.log("should be stuffs here")
				
				dfd = $('#images').imagesLoaded(); 
				dfd.always(
					function(){
						$("#images").scrollTop(scrollpos)
						}
				)

});

/////////////Functions///////////

//cribbed from http://stackoverflow.com/a/1349426/565514
function makeid(){
    var text = "";
    var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

    for( var i=0; i < 5; i++ )
        text += possible.charAt(Math.floor(Math.random() * possible.length));

    return text;
}

function build_output(data){
	imgout = "<center>"
	widther = $("#images").width() - 1
	if (widther > maxwidth) widther = maxwidth

	outputdata = ""
	boots = data['out']	
	foots = boots.split("\n")
	if (boots.search("top") == 0) 
	{
		$("#status").html("waiting for result")
		for (var f=0; f <foots.length;f++)
		{
			if (foots[f].search("PID")>-1)
			{ 
				headers =foots[f].trim().replace(/\s+/g,' ').split(" ")
				things = foots[f+1].trim().replace(/\s+/g,' ').split(" ")
			}
		}
		
		outputdata+='<table>'
		
		for (i in headers)
		{
			outputdata+='<tr><td>'+headers[i]+"</td><td>"+ things[i]+"</td></tr>"
		} 
		outputdata+='</table>'
		
		
	}
	else
	{
		for (i in foots)
		{
			if (foots[i].search("##_holder_##")==0) outputdata += "<img width='" + widther+"px'src='"+foots[i].replace("##_holder_##:","")+"'><br>"
			else outputdata += foots[i]+"<br>"
		}

	}
	//Build python stderr
	boots = data['outerr']
	if (boots == null) boots = ""
	while (boots.search("\n") > -1) boots = boots.replace("\n","<br>")
	outputdata += "<br><span style='color:red'>"+boots+"</span>"
	$("#images").html(outputdata)
}

function loader(bool,page){

	$.ajax({
	  url: "read/",
	  async:bool,
	  type:"POST",
	  data:{page_name:page,value:editor.getSession().getValue()},
	  success: function(data){
	 		editor.getSession().setValue(data['script'])

	  }
	});

}

function saver(bool,page){

	//editor.save()
	if (!waiting_for_output)
	{ 
	waiting_for_output = true
	script_name = $("#scriptname").val()
	$("#status").html("waiting for result");
	
	if ($.trim(editor.getSession().getValue()) != "Fill Me Up")
	{
		//console.log("Changed!");
		$.ajax(
		{
		  url: this_port+"run/",
		  type:"POST",
		  async:bool,
		  data:{page_name:page,script_name:script_name,value:editor.getSession().getValue()},
		 
		})
	}
	}
}

function history(page){
	//console.log("loading!");

	$.ajax({
	  url: "/history/",
	  async:true,
	  type:"POST",
	  data:{page_name:page,value:editor.getSession().getValue()},
	  success: function(data){
		//data = JSON.parse(data);
		out = data['out']
		if (out == undefined) out = []
		//console.log(out)
		if (out.length > 1)
		{
			selecters = "<select id='histories' class='selectig'>"
			for (i in out)
			{
				selecters += '<option value="'+out[i][0]+'">'+out[i][1]+'</option>'
			}
			selecters += "</select>"
			$("#history_box").html(selecters)
			$("#histories").change(
				function(){get_data()})
		}
	}
	});
	
}

function get_data(){	
	loader(false,$("#histories").val());
	console.log($("#histories").val())
}

function make_option(word){
  foo = "<option value='Milk'>Milk</option>";
  return foo.replace(/Milk/gi,word)
}

//Editor Stuff
$(window).resize(function(){
	try
	{
		build_output(gotdata)
	}
	catch (err)
	{
		//console.log(err)
	}
	area.width($("#left-side").width())
	area.height($(document).height()*height_factor)
	
})

//store editor prefs per browser
function setCookie(c_name,value)
{
	exdays = null
	var exdate=new Date();
	exdate.setDate(exdate.getDate() + exdays);
	var c_value=escape(value) + ((exdays==null) ? "" : "; 	expires="+exdate.toUTCString());
	document.cookie=c_name + "=" + c_value;
}

function getCookie(c_name)
{
var i,x,y,ARRcookies=document.cookie.split(";");
for (i=0;i<ARRcookies.length;i++)
{
  x=ARRcookies[i].substr(0,ARRcookies[i].indexOf("="));
  y=ARRcookies[i].substr(ARRcookies[i].indexOf("=")+1);
  x=x.replace(/^\s+|\s+$/g,"");
  if (x==c_name)
    {
    return unescape(y);
    }
  }
}

</script>
